{% extends 'automation/base.html' %}
{% block title %}JF Metrics | Nova Atividade{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <div class="mb-4">
    <a href="{% url 'automation:dashboard' %}" class="text-sm text-slate-500 hover:text-slate-700 inline-flex items-center gap-1">
      <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar ao dashboard
    </a>
  </div>

  <div class="bg-white rounded-2xl shadow p-6">
    <h1 class="text-xl font-semibold mb-5 flex items-center gap-2">
      <i data-lucide="plus-circle" class="w-5 h-5 text-slate-600"></i> Nova atividade
    </h1>

    {% if form.non_field_errors %}
      <div class="mb-4 rounded-xl border border-rose-200 bg-rose-50 p-3 text-rose-700 text-sm">
        {% for error in form.non_field_errors %}
          <div class="flex items-start gap-2">
            <i data-lucide="alert-triangle" class="w-4 h-4 mt-0.5"></i>
            <span>{{ error }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" class="space-y-6" novalidate>
      {% csrf_token %}

      <!-- Projeto -->
      <div>
        <label class="block">
          <span class="text-sm text-slate-700">Projeto</span>
          <div class="relative mt-1">
            <i data-lucide="briefcase" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
            {{ form.project }}
            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
          </div>
        </label>
        {% if form.project.errors %}
          <div class="mt-1 text-sm text-rose-600">
            {% for error in form.project.errors %}<div>• {{ error }}</div>{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Classificação -->
      <div>
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-slate-700">Classificação</span>
          <span class="text-[11px] text-slate-500">Use os selects abaixo ou os campos personalizados</span>
        </div>

        <!-- agora 3 colunas em md para melhor aproveitamento -->
        <div class="grid md:grid-cols-3 gap-4 mt-2">
          <!-- Marco -->
          <label class="block">
            <span class="text-sm text-slate-600">Marco</span>
            <div class="relative mt-1">
              <i data-lucide="git-branch" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              {{ form.milestone }}
              <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
            </div>
            {% if form.milestone.errors %}
              <div class="mt-1 text-sm text-rose-600">{% for error in form.milestone.errors %}<div>• {{ error }}</div>{% endfor %}</div>
            {% endif %}
          </label>

          <!-- Atividade Geral -->
          <label class="block">
            <span class="text-sm text-slate-600">Atividade Geral</span>
            <div class="relative mt-1">
              <i data-lucide="layers" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              {{ form.general }}
              <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
            </div>
            {% if form.general.errors %}
              <div class="mt-1 text-sm text-rose-600">{% for error in form.general.errors %}<div>• {{ error }}</div>{% endfor %}</div>
            {% endif %}
          </label>

          <!-- Atividade Específica -->
          <label class="block">
            <span class="text-sm text-slate-600">Atividade Específica</span>
            <div class="relative mt-1">
              <i data-lucide="list-checks" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
              {{ form.specific }}
              <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
            </div>
            {% if form.specific.errors %}
              <div class="mt-1 text-sm text-rose-600">{% for error in form.specific.errors %}<div>• {{ error }}</div>{% endfor %}</div>
            {% endif %}
          </label>
        </div>
      </div>

      <!-- Divider OU -->
      <div class="flex items-center gap-3">
        <div class="h-px flex-1 bg-slate-200"></div>
        <div class="text-[11px] uppercase tracking-wide text-slate-400">ou</div>
        <div class="h-px flex-1 bg-slate-200"></div>
      </div>

      <!-- Ad-hoc -->
      <div>
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-slate-700">Campos personalizados</span>
          <span class="text-[11px] text-slate-500">Preencha se não houver opção nos selects acima</span>
        </div>
        <div class="grid md:grid-cols-3 gap-4 mt-2">
          <label class="block">
            <span class="text-sm text-slate-600">Marco (personalizado)</span>
            {{ form.custom_milestone }}
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">Atividade Geral (personalizado)</span>
            {{ form.custom_general }}
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">Atividade Específica (personalizado)</span>
            {{ form.custom_specific }}
          </label>
        </div>
      </div>

      <!-- Descrição -->
      <div>
        <label class="block">
          <span class="text-sm text-slate-700">Descrição</span>
          {{ form.description }}
        </label>
      </div>

      <!-- Ações -->
      <div class="flex flex-wrap gap-2">
        <button class="px-4 py-2 rounded-xl bg-brand text-white flex items-center gap-2 hover:brightness-110 transition focus:outline-none focus:ring-2 focus:ring-emerald-300">
          <i data-lucide="play" class="w-4 h-4"></i> Iniciar e salvar
        </button>
        <a href="{% url 'automation:dashboard' %}" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50 transition">
          Cancelar
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Ícones
  window.addEventListener('load', () => { if (window.lucide) lucide.createIcons(); });

  /* ===== Encadeamento ATIVADO (usa data-*) ===== */
  (function () {
    const $ = (sel) => document.querySelector(sel);
    const milestoneSel = $('.js-select-milestone');
    const generalSel   = $('.js-select-general');
    const specificSel  = $('.js-select-specific');

    function ensureVisibleValue(select) {
      if (!select) return;
      const opt = select.options[select.selectedIndex];
      if (!opt || opt.hidden || opt.disabled) select.value = "";
    }

    function hasDataAttrs(select, attrName) {
      if (!select) return false;
      return Array.from(select.options).some(o => o.value && o.hasAttribute(attrName));
    }

    function filterByParent(childSelect, parentSelect, attrName) {
      if (!childSelect) return;
      const parentId = parentSelect && parentSelect.value ? parentSelect.value : null;

      // Se o widget não trouxe data-*, não filtra nada (fallback seguro)
      if (!hasDataAttrs(childSelect, attrName)) {
        Array.from(childSelect.options).forEach(opt => { opt.hidden = false; opt.disabled = false; });
        ensureVisibleValue(childSelect);
        return;
      }

      Array.from(childSelect.options).forEach(opt => {
        if (!opt.value) { opt.hidden = false; opt.disabled = false; return; } // placeholder
        const parentAttr = opt.getAttribute(attrName);
        const show = !parentId || parentAttr === parentId;
        opt.hidden = !show;
        opt.disabled = !show;
      });

      ensureVisibleValue(childSelect);
    }

    function filterGenerals()  { filterByParent(generalSel,  milestoneSel, 'data-milestone'); }
    function filterSpecifics() { filterByParent(specificSel, generalSel,   'data-general');  }

    // Inicial
    filterGenerals();
    filterSpecifics();

    // Encadeamento
    if (milestoneSel) milestoneSel.addEventListener('change', () => { filterGenerals(); filterSpecifics(); });
    if (generalSel)   generalSel.addEventListener('change',   () => { filterSpecifics(); });
  })();

  /* ===== Exclusividade selects x ad-hoc ===== */
  (function () {
    const pairs = [
      { select: '.js-select-milestone', adhoc: '.js-adhoc-milestone' },
      { select: '.js-select-general',   adhoc: '.js-adhoc-general' },
      { select: '.js-select-specific',  adhoc: '.js-adhoc-specific' },
    ];

    function syncPair(selectEl, adhocEl) {
      const hasSelect = selectEl && selectEl.value && selectEl.value !== '';
      const hasAdhoc  = adhocEl && adhocEl.value && adhocEl.value.trim() !== '';

      if (adhocEl) {
        adhocEl.disabled = !!hasSelect;
        adhocEl.classList.toggle('bg-slate-50', !!hasSelect);
        adhocEl.classList.toggle('cursor-not-allowed', !!hasSelect);
        adhocEl.classList.toggle('opacity-70', !!hasSelect);
      }
      if (selectEl) {
        selectEl.disabled = !!hasAdhoc;
        selectEl.classList.toggle('bg-slate-50', !!hasAdhoc);
        selectEl.classList.toggle('cursor-not-allowed', !!hasAdhoc);
        selectEl.classList.toggle('opacity-70', !!hasAdhoc);
      }
    }

    function wirePair(pair) {
      const selectEl = document.querySelector(pair.select);
      const adhocEl  = document.querySelector(pair.adhoc);
      if (!selectEl || !adhocEl) return;

      syncPair(selectEl, adhocEl);
      selectEl.addEventListener('change', () => syncPair(selectEl, adhocEl));
      adhocEl.addEventListener('input', () => syncPair(selectEl, adhocEl));
    }

    pairs.forEach(wirePair);
  })();
</script>
{% endblock %}
